name: Update Erregame Data and Images
on:
  schedule:
    - cron: '0 0 * * *' # Si esegue ogni notte a mezzanotte
  workflow_dispatch: # Permette l'avvio manuale cliccando su "Run Workflow"

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Necessario per permettere a GitHub di salvare i file nel repo
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pandas requests

      - name: Download and Process
        run: |
          python - <<EOF
          import pandas as pd
          import requests
          import os
          import time

          # Header per simulare un browser ed evitare il blocco di Erregame
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36'
          }
          url_csv = "https://www.erregame.com/CSV/%7BAEA32292-14DB-4EF5-A687-1FB02B2143F5%7D.csv"

          # 1. Scarica il file CSV originale
          print("Scaricando il listino CSV...")
          try:
              res = requests.get(url_csv, headers=headers)
              res.raise_for_status()
              with open('listino.csv', 'wb') as f:
                  f.write(res.content)
              print("CSV scaricato con successo.")
          except Exception as e:
              print(f"Errore critico nel download del CSV: {e}")
              exit(1)

          # 2. Carica i dati (Separatore Tabulatore e Encoding Latin1 come nel file analizzato)
          try:
              df = pd.read_csv('listino.csv', sep='\t', encoding='latin1')
              print(f"Dati caricati: {len(df)} prodotti trovati.")
          except Exception as e:
              print(f"Errore nella lettura del CSV: {e}")
